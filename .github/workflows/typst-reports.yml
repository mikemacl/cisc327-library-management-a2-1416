name: build typst reports

on:
    push:
        paths:
            - "reports/A1/report.typ"
            - "reports/A2/report.typ"
            - "reports/A3/report.typ"

jobs:
    compile-reports:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - label: A1
                      typst: reports/A1/report.typ
                      pdf: A1_MacLennan_20121416.pdf
                    - label: A2
                      typst: reports/A2/report.typ
                      pdf: A2_MacLennan_20121416.pdf
                    - label: A3
                      typst: reports/A3/report.typ
                      pdf: A3_MacLennan_20121416.pdf
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Detect if ${{ matrix.label }} changed
              id: changed
              run: |
                  BASE_SHA="${{ github.event.before }}"
                  if [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ] || [ -z "$BASE_SHA" ]; then
                    BASE_SHA=$(git rev-list --max-parents=0 HEAD)
                  fi
                  if git diff --name-only "$BASE_SHA" HEAD -- "${{ matrix.typst }}" | grep -q .; then
                    echo "changed=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "changed=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Setup Typst
              if: steps.changed.outputs.changed == 'true'
              uses: typst-community/setup-typst@v3

            - name: Compile ${{ matrix.label }}
              if: steps.changed.outputs.changed == 'true'
              run: typst compile "${{ matrix.typst }}" "${{ matrix.pdf }}"

            - name: Upload ${{ matrix.label }} artifact
              if: steps.changed.outputs.changed == 'true'
              uses: actions/upload-artifact@v4
              with:
                  name: "${{ matrix.pdf }}"
                  path: "${{ matrix.pdf }}"
